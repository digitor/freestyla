"use strict";!function(){function getUID(pref){return(pref||"")+Math.random().toString().replace(".","")}function getInstance(uid){var instance;if(!uid&&1===instances.length)return instances[0];for(var i=0;i<instances.length;i++)if(instance=instances[i],instance.uid===uid)return instance;return console.warn(NS,"Couldn't find an instance with UID "+uid,"instances count: "+instances.length),null}function createNewInstance(rtnInst){var uid=getUID("instance"),inst={uid:uid};return instances.push(inst),rtnInst?inst:uid}function clearAllInstances(){instances=[]}function sortTempWidgetOrder(uid,useTempWg,widgetName,cssFile){var inst=getInstance(uid);if(inst.tempQueryList&&!(inst.tempQueryList.length<=1)&&(useTempWg&&($('[href="'+cssFile+'"]').attr("data-order",inst.tempQueryList.indexOf(widgetName)),inst.tempWgCount++),inst.tempWgCount===inst.tempQueryList.length))for(var $thisLink,dataInd,$links=$('[href*="css/min/TEMP_"]').detach(),linkCount=inst.tempQueryList.length;linkCount>0;)$links.each(function(){$thisLink=$(this),dataInd=parseInt($thisLink.attr("data-order")),dataInd===linkCount-1&&($("body").prepend($thisLink),linkCount--)})}function getTempWidgetQueryList(href){href||(href=window.location.href);var queryArr=href.split("?"),queries=queryArr.length>1?queryArr[1]:null;if(!queries||-1===queries.indexOf("tempwg"))return null;var tempQueryArr=queries.split("tempwg="),tempQuery=tempQueryArr[1].split("&")[0].replace("#","");return tempQuery.split(",")}function callConfigCBs(uid,cnf,allowAll){var inst=getInstance(uid);if(!allowAll&&cnf.loaded===!0)return!1;if(cnf.$el&&cnf.$el.closest("."+clsLoading).length)return-1===inst.notYetVisibleWgList.indexOf(cnf)&&inst.notYetVisibleWgList.push(cnf),!1;var wgName=cnf.wgName;return _.forEach(cnf.cb,function(cb){cb(wgName)}),!0}function callNotVisibleList(uid){for(var cnf,loaded,inst=getInstance(uid),i=inst.notYetVisibleWgList.length-1;i>-1;i--)cnf=inst.notYetVisibleWgList[i],loaded=callConfigCBs(uid,cnf),loaded&&(inst.notYetVisibleWgList.splice(i,1),cnf.loaded=!0)}function triggerUnloadedCBs(uid,wgName,cnf){var loaded;if(cnf.loaded){if("*"===cnf.wgName)return loaded=callConfigCBs(uid,cnf,!0)}else if(wgName===cnf.wgName||"*"===cnf.wgName)return loaded=callConfigCBs(uid,cnf),loaded&&(cnf.loaded=!0),loaded;return!1}function triggerRegisteredCallbacks(uid,wgName){var inst=getInstance(uid);inst.notYetVisibleWgList||(inst.notYetVisibleWgList=[]);var registeredWidgets=window.freeStyla.glb.registeredWidgets;callNotVisibleList(uid),_.forEach(registeredWidgets,function(cnf){triggerUnloadedCBs(uid,wgName,cnf)});var matches=_.where(registeredWidgets,{wgName:wgName});0===matches.length&&registeredWidgets.push({wgName:wgName,loaded:!0,cb:[]})}function startCSSLoading(uid,widgetName,$thisWg,useTempWg,successCB){var cssFile=(getInstance(uid),freeStyla.glb.buildDirCSS+"widgets/"+widgetName+".css");if(useTempWg)cssFile=freeStyla.glb.buildDirCSS+"TEMP_"+widgetName+".css";else{var matches=_.where(window.freeStyla.glb.registeredWidgets,{wgName:widgetName,loaded:!0});if(matches.length)return triggerRegisteredCallbacks(uid,widgetName),$doc.trigger("freestyla-css-loaded",{wgName:widgetName,isSuccess:!0}),successCB&&successCB(widgetName,!0),!0}return ensureStylesLoaded($thisWg,cssFile,function(isSuccess){sortTempWidgetOrder(uid,useTempWg,widgetName,cssFile),$("."+widgetName).removeClass(clsLoading),triggerRegisteredCallbacks(uid,widgetName),$doc.trigger("freestyla-css-loaded",{wgName:widgetName,isSuccess:isSuccess}),successCB&&successCB(widgetName,isSuccess)}),!1}function ensureStylesLoaded($thisWg,cssFile,cb,attemptCount){var freestylaEl=document.getElementById(MAIN_ID);freestylaEl||(freestylaEl=document.createElement("span"),freestylaEl.setAttribute("id",MAIN_ID),document.body.insertBefore(freestylaEl,document.body.firstChild));var ss=loadCSS(cssFile,freestylaEl);ss.setAttribute("data-freestyla-ss",""),onloadCSS(ss,function(){var count=0,checkLoaded=function(){var wgCSSOk=!$thisWg||"visible"===$thisWg.eq(0).css("visibility");wgCSSOk?cb(!0):(count++,setTimeout(checkLoaded,300))};checkLoaded()}),ss.onerror=function(){cb(!1)}}var SELF,freeStyla,loadCSS,onloadCSS,$doc,NS="freeStyla",MAIN_ID="freestyla",CSS_LOADED_EVT="freestyla-css-loaded",clsLoading="cssload-hide",instances=[];"undefined"!=typeof window&&(loadCSS=window.loadCSS,onloadCSS=window.onloadCSS,$doc=$(document)),freeStyla={suppressWarnings:!1,prepare:function(registeredWidgets,buildDirCSS,widgetNames,dynamicCSS){SELF.glb=SELF.glb||{},SELF.glb.registeredWidgets=registeredWidgets,SELF.glb.buildDirCSS=buildDirCSS,SELF.glb.widgetNames=widgetNames,SELF.glb.dynamicCSS=dynamicCSS},start:function($,_,priorityWgList,registeredWidgets){var inst=createNewInstance(!0),uid=inst.uid,$wrongAttr=$("[data-wg-load]");0!==$wrongAttr.length&&console.warn(NS,"onDemandCSS()","Whoops! Looks like you've used 'data-wg-load' somewhere instead of 'data-load-wg' as an attribute",$wrongAttr),inst.tempWgCount=0,inst.tempQueryList=SELF.getTempWidgetQueryList(),inst.registeredWidgets=registeredWidgets||[];var $thisWg,widgetsList=window.freeStyla.glb.widgetNames,wgLoadList=[];_.forEach(widgetsList,function(widgetName){widgetName=widgetName.toLowerCase();var isPriority=!1;_.map(priorityWgList,function(item){item.toLowerCase()===widgetName&&(isPriority=!0)}),$thisWg=$("."+widgetName);var useTempWg=inst.tempQueryList&&-1!==inst.tempQueryList.indexOf(widgetName);if(0!==$thisWg.length)wgLoadList.push({name:widgetName,$wg:$thisWg,useTempWg:useTempWg,isPriority:isPriority});else{var $attrMatch=SELF.checkLoadCssAttr($,_,widgetName);$attrMatch&&wgLoadList.push({name:widgetName,$wg:$attrMatch,useTempWg:useTempWg,isPriority:isPriority})}});var priorityList=_.where(wgLoadList,{isPriority:!0}),nonPriorityList=_.where(wgLoadList,{isPriority:!1}),loadedCount=0,loadNonPriority=function(){_.forEach(nonPriorityList,function(item){startCSSLoading(uid,item.name,item.$wg,item.useTempWg)})};return 0===priorityList.length?void loadNonPriority():(_.forEach(priorityList,function(item){startCSSLoading(uid,item.name,item.$wg,item.useTempWg,function(){loadedCount++,loadedCount===priorityList.length&&loadNonPriority()})}),uid)},removeCriticalCssLoad:function(uid){var $thisWg,inst=getInstance(uid);_.forEach(inst.registeredWidgets,function(item){item.loaded&&"*"!==item.wgName&&($thisWg=$("."+item.wgName),$thisWg.length&&$thisWg.removeClass(clsLoading))})},handleWgCSSLoad:function(ns,singleCB,cb){if(!ns||!cb)return void console.warn("utils -> handleWgCSSLoad()","You must supply a 'ns' and 'cb' param. Returning early.");if(!window.freeStyla.glb.dynamicCSS)return void cb();if(!singleCB)return void SELF.freeLoaded(ns,cb);var total,count=0;_.isArray(ns)&&(total=ns.length),"object"!=typeof ns||_.isArray(ns)||(total=_.isArray(ns.ns)?ns.ns.length:1),SELF.freeLoaded(ns,function(wgName){count++,count===total&&cb(wgName)})},freeLoaded:function(ns,cb){if(!window.freeStyla.glb.dynamicCSS)return void cb();var list;"string"==typeof ns?list=[ns]:_.isArray(ns)&&(list=ns);var registeredWidgets=window.freeStyla.glb.registeredWidgets,addNSArray=function(list,isNewCB){_.forEach(list,function(wgName){wgName=wgName.toLowerCase();var config=_.where(registeredWidgets,{wgName:wgName});config.length?(config=config[0],config.loaded?cb(wgName):config.cb.push(cb)):isNewCB(wgName)})};if(!list){var $el=ns.$el||ns;$el.length||console.warn("utils -> freeLoaded","You tried to pass an element, but length was zero.");var namespace=ns.ns||"*";return void addNSArray(_.isArray(namespace)?namespace:[namespace],function(wgName){registeredWidgets.push({wgName:wgName,loaded:!1,$el:$el,cb:[cb]})})}addNSArray(list,function(wgName){registeredWidgets.push({wgName:wgName,loaded:!1,cb:[cb]})})},checkLoadCssAttr:function($,_,matchWgName){var $this,match=null,$loadCssList=$("[data-load-wg]");return $loadCssList.each(function(){$this=$(this),_.forEach($this.attr("data-load-wg").split(" "),function(wgName){matchWgName===wgName&&(match=$this)})}),match},testable:{getUID:getUID,createNewInstance:createNewInstance,getInstance:getInstance,clearAllInstances:clearAllInstances,callConfigCBs:callConfigCBs,callNotVisibleList:callNotVisibleList,triggerUnloadedCBs:triggerUnloadedCBs,triggerRegisteredCallbacks:triggerRegisteredCallbacks,getTempWidgetQueryList:getTempWidgetQueryList,ensureStylesLoaded:ensureStylesLoaded,startCSSLoading:startCSSLoading},vars:{NS:NS,clsLoading:clsLoading,MAIN_ID:MAIN_ID,CSS_LOADED_EVT:CSS_LOADED_EVT}},"undefined"==typeof window?module.exports=freeStyla:window.freeStyla=window.freestyla=freeStyla,SELF=freeStyla}();